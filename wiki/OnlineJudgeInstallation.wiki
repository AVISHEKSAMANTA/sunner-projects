#summary How to install/upgrade/use onlinejudge assignment type for moodle
#labels OnlineJudge

= Installation =
== 1. Patch Moodle Official Code ==

Edit mod/assignment/mod_form.php. Change
{{{
$assignmentinstance->setup_elements($mform);
}}}
to
{{{
$assignmentinstance->setup_elements($mform, $this);
}}}

== 2. Download Online Judge==

Download from http://code.google.com/p/sunner-projects/downloads/list

Untar and put onlinejudge/ into mod/assignment/type/

== 3. Make sandbox ==

In mod/assignment/type/onlinejudge/sandbox/, run:
{{{
make
}}}

== 4. Apply ==

  # Login moodle as admin
  # Access http://site.domain.name/admin/index.php
  # Follow the instructions shown by above url 

== 5. Make Judge Work==

This plug-in uses daemon or [http://docs.moodle.org/en/Cron moodle cron job] to judge submissions. There are three different ways to make the judge work. The first is the most recommended and the last is the least recommended. 

=== 5.1. Create Judge Daemon Through Cron ===

If you can setup your moodle's cron job to be called by php cli, this is your best choice for convenience. That means in crontab, put a command which is similar with: 

{{{
php -q /PATH/TO/MOODLE/admin/cron.php
}}}

That's all! Read [http://docs.moodle.org/en/Cron] for detail about how to setup moodle cron job. 

If cron job works, the judge daemon can be created automatically. Use

{{{
ps -FC php
}}}

to ensure the daemon is running.

=== 5.2. Create Judge Daemon in Command Line===

If you'd like or have to trigger cron through http, the way below is your best choice.

In command line, run the following command to create daemon:

{{{
sudo -u APACHE-USER php /PATH/TO/MOODLE/mod/assignment/type/onlinejudge/judged.php
}}}

The APACHE-USER means the username of apache in your system. It is _www-data_ in debian, _apache_ in fedora. _`ps aux|grep apache`_ or _`ps aux|grep httpd`_ can help you getting the correct username.

Use

{{{
ps -FC php
}}}

to ensure the daemon is running.

You'd better to make the script as an autorun command through adding it into /etc/rc.local or other ways. Please reference your system's manual for how to configure autorun command.

=== 5.3. Judge Through Cron Job ===

Well, in this way, there always is a delay between submitting and judge. Tell the students to be patient.

First, make sure the [http://docs.moodle.org/en/Cron moodle cron job] works.

In config.php, add the following line of code:

{{{
$CFG->assignment_oj_judge_in_cron = true;
}}}

That's all.

= Upgrade =

  # Overwrite the directory, onlinejudge/, with latest version.
  # Repeat step 2-4 in Installation
  # If you are using 5.2 way, run `sudo -u APACHE-USER php /PATH/TO/MOODLE/mod/assignment/type/onlinejudge/judged.php` again. 
  # 5.1 and 5.3 can apply the upgrade automatically.

= Usage =

The same as other standard assignment types. Follow its inline help.